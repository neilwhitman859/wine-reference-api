<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wine Reference API</title>
    <style>
      :root {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color-scheme: light;
        --bg: #f4f1f6;
        --panel: #ffffff;
        --ink: #241b24;
        --muted: #665f6b;
        --brand: #6f1d46;
        --brand-2: #a93f74;
        --edge: #e8dfeb;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 15% -10%, #f8dce9, transparent 36%), radial-gradient(circle at 100% 0%, #e1d6f8, transparent 30%), var(--bg);
        color: var(--ink);
      }
      .wrap {
        max-width: 1280px;
        margin: 32px auto 48px;
        padding: 0 20px;
      }
      .app-shell {
        background: color-mix(in srgb, var(--panel) 88%, #ffffff);
        border: 1px solid var(--edge);
        border-radius: 24px;
        padding: 30px;
        box-shadow: 0 24px 55px rgba(53, 20, 48, 0.12);
      }
      h1 { margin: 0; font-size: 2rem; letter-spacing: -.02em; }
      .lead { color: var(--muted); margin: 8px 0 22px; max-width: 80ch; line-height: 1.45; }
      .query-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 180px auto;
        gap: 12px;
        align-items: end;
      }
      label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
      input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #d8ccdf;
        background: #fff;
        padding: 11px 12px;
        font-size: 14px;
      }
      input:focus-visible { outline: 2px solid #d88cb0; border-color: #d88cb0; }
      button {
        border: 0;
        border-radius: 12px;
        padding: 11px 16px;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
        background: linear-gradient(135deg, var(--brand), var(--brand-2));
        box-shadow: 0 8px 18px rgba(111, 29, 70, 0.35);
      }
      button:disabled { opacity: .65; cursor: wait; }
      .status { min-height: 20px; margin-top: 12px; color: var(--muted); }
      .error { color: #ac1e36; }
      .history {
        margin-top: 18px;
        border-radius: 14px;
        border: 1px solid var(--edge);
        padding: 14px;
        background: #fcfafe;
      }
      .history h3 { margin: 0 0 8px; font-size: 15px; }
      .history ul { margin: 0; padding-left: 18px; color: #4d4651; }
      .result {
        margin-top: 18px;
        border-radius: 18px;
        border: 1px solid var(--edge);
        background: linear-gradient(180deg, #fff 0%, #fef9ff 100%);
        padding: 20px;
        min-height: 150px;
      }
      .hero {
        display: grid;
        gap: 18px;
        grid-template-columns: minmax(0, 1fr) 240px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--edge);
      }
      .hero h2 { margin: 0; font-size: 1.65rem; }
      .hero p { margin: 10px 0 0; line-height: 1.5; color: #4d4550; }
      .chip { display: inline-block; font-size: 12px; padding: 4px 10px; border: 1px solid #e0d1e5; border-radius: 999px; margin-right: 6px; margin-top: 10px; background: #faf0f6; }
      .source-note {
        margin-top: 10px;
        font-size: 13px;
        color: #5e525f;
      }
      .score {
        border: 1px solid #e2cfe4;
        border-radius: 16px;
        padding: 14px;
        background: linear-gradient(145deg, #fcf2f8, #f7f4ff);
      }
      .score .label { font-size: 12px; color: #6a5f6f; text-transform: uppercase; letter-spacing: .08em; }
      .score .value { font-size: 2rem; font-weight: 800; color: var(--brand); margin-top: 4px; }
      .section-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
        margin-top: 16px;
      }
      .panel {
        border: 1px solid var(--edge);
        border-radius: 14px;
        background: #fff;
        padding: 14px;
      }
      .panel h3 { margin: 0 0 10px; font-size: 1rem; }
      .facts-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .fact { border: 1px solid #ede4f0; background: #fdfbff; border-radius: 10px; padding: 9px; }
      .fact .label { font-size: 12px; color: #6d6372; }
      .fact .value { font-size: 14px; font-weight: 600; margin-top: 3px; }
      .viz-list { margin: 0; padding: 0; list-style: none; display: grid; gap: 8px; }
      .viz-item { display: grid; gap: 6px; }
      .viz-head { display: flex; justify-content: space-between; font-size: 13px; }
      .meter { height: 10px; border-radius: 999px; background: #eee6f2; overflow: hidden; }
      .meter > span { display: block; height: 100%; border-radius: inherit; background: linear-gradient(90deg, #bc5b8f, #6f1d46); }
      ul { margin: 8px 0 0; padding-left: 18px; }
      .meta { margin-top: 10px; color: #716678; font-size: 12px; }
      .metadata { display: none; }
      @media (max-width: 980px) {
        .query-grid, .hero, .section-grid, .facts-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="app-shell">
        <h1>Wine Reference</h1>
        <p class="lead">Explore a wine by producer, place, and vintage with richer visuals and cleaner structure. Enter a bottle and optional year to generate a full profile.</p>

        <form id="wine-form" class="query-grid">
          <div>
            <label for="name">Wine name</label>
            <input id="name" name="name" placeholder="e.g., Opus One" required />
          </div>
          <div>
            <label for="vintage">Vintage (optional)</label>
            <input id="vintage" name="vintage" type="number" placeholder="e.g., 2018" min="1900" max="2100" />
          </div>
          <div><button type="submit" id="submit-btn">Generate profile</button></div>
        </form>

        <div id="status" class="status"></div>
        <section class="history">
          <h3>Last 10 bottles searched</h3>
          <ul id="search-history"></ul>
        </section>

        <div id="result" class="result">Your redesigned wine profile will appear here.</div>
        <div class="meta">Last updated: <time id="last-updated"></time></div>
      </section>
    </main>

    <script>
      const form = document.getElementById("wine-form");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      const submitBtn = document.getElementById("submit-btn");
      const lastUpdatedEl = document.getElementById("last-updated");
      const searchHistoryEl = document.getElementById("search-history");
      const SEARCH_HISTORY_KEY = "wine-search-history-v2";

      lastUpdatedEl.textContent = new Date(document.lastModified).toLocaleString();
      lastUpdatedEl.dateTime = new Date(document.lastModified).toISOString();

      const safe = (v, fallback = "Not disclosed") => (v === null || v === undefined || v === "" ? fallback : v);
      const listItems = (items = [], empty = "Not available") =>
        Array.isArray(items) && items.length ? items.map((i) => `<li>${i}</li>`).join("") : `<li>${empty}</li>`;

      const parseGrapes = (text = "") => {
        const matches = [...(text || "").matchAll(/(\d{1,3})\s?%\s*([A-Za-z][A-Za-z\s\-]+)/g)];
        if (!matches.length) return [];
        return matches.map((m) => ({ percent: Number(m[1]), grape: m[2].trim().replace(/[.,;:]$/, "") }));
      };

      const parseProducerRegion = (text = "") => {
        const parts = (text || "").split(",").map((p) => p.trim()).filter(Boolean);
        if (!parts.length) return { producer: "Not disclosed", region: "Not disclosed" };
        return { producer: parts[0], region: parts.slice(1).join(", ") || "Not disclosed" };
      };

      const weatherInterpretation = (comparison = {}) => {
        const temp = comparison.avg_high_delta_c || 0;
        const rain = comparison.rain_total_delta_mm || 0;
        if (temp > 1.8 && rain < -25) return "Hot and dry season likely pushed ripeness and concentration.";
        if (temp < -1.3 && rain > 25) return "Cooler and wetter season likely emphasized freshness and tension.";
        return "Balanced weather profile, typically associated with moderate structure and style.";
      };

      const vintageRank = (comparison = {}) => {
        const heat = Math.abs(comparison.avg_high_delta_c || 0);
        const rain = Math.abs(comparison.rain_total_delta_mm || 0);
        const score = Math.max(1, Math.min(5, 5 - heat * 0.9 - rain / 40));
        return `${score.toFixed(1)}/5`;
      };

      const formatCurrency = (n) => new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(n || 0);

      const estimatePrice = (vintage, weather = {}) => {
        const yr = new Date().getFullYear();
        const age = vintage ? Math.max(0, yr - vintage) : 4;
        const tempDelta = Math.abs(weather?.selected_vs_average_comparison?.avg_high_delta_c || 0);
        const score = Math.max(0.8, 1.2 - tempDelta * 0.08);
        const avg = Math.round(45 * (1 + Math.min(age / 18, 0.8)) * score);
        return { avg, low: Math.max(20, Math.round(avg * 0.8)), high: Math.round(avg * 1.25) };
      };

      const loadSearchHistory = () => {
        try {
          const raw = localStorage.getItem(SEARCH_HISTORY_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch { return []; }
      };

      const saveSearchHistory = (entries) => localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(entries));

      const renderSearchHistory = () => {
        const entries = loadSearchHistory();
        searchHistoryEl.innerHTML = entries.length
          ? entries.map((e) => `<li><strong>${e.name}</strong> · ${e.vintage} · ${e.grapes}</li>`).join("")
          : "<li>No bottles searched yet.</li>";
      };

      const recordSearch = (entry) => {
        const entries = loadSearchHistory().filter((e) => !(e.name === entry.name && e.vintage === entry.vintage));
        entries.unshift(entry);
        saveSearchHistory(entries.slice(0, 10));
        renderSearchHistory();
      };

      const vizRow = (label, current, avg, unit = "") => {
        const max = Math.max(Math.abs(current || 0), Math.abs(avg || 0), 1);
        const pct = Math.min(100, Math.max(8, (Math.abs(current || 0) / max) * 100));
        return `
          <li class="viz-item">
            <div class="viz-head"><strong>${label}</strong><span>${safe(current, "N/A")}${unit} vs ${safe(avg, "N/A")}${unit}</span></div>
            <div class="meter"><span style="width:${pct}%"></span></div>
          </li>`;
      };

      const renderResult = (data) => {
        const breakdown = data.description_breakdown || {};
        const tasting = breakdown.tasting_profile || {};
        const mouth = breakdown.drinking_experience || {};
        const weather = data.growing_season_weather || {};
        const comparison = weather.selected_vs_average_comparison || {};
        const producerRegion = parseProducerRegion(breakdown.producer_and_region || "");
        const grapes = parseGrapes(breakdown.grape_composition_and_style || "");
        const grapeNames = grapes.length ? grapes.map((g) => g.grape).join(", ") : "Not disclosed";
        const blend = grapes.length ? grapes.map((g) => `${g.grape} ${g.percent}%`).join(", ") : "Optional / Not disclosed";
        const climate = data.raw_openai_payload?.climate_context || {};
        const growing = climate.growing_season || {};

        const price = estimatePrice(data.vintage, weather);
        recordSearch({ name: safe(data.wine, "Unknown wine"), vintage: safe(data.vintage, "N/V"), grapes: grapeNames });

        return `
          <div class="hero">
            <div>
              <h2>${safe(data.wine, "Wine")} ${data.vintage ? `(${data.vintage})` : ""}</h2>
              <p>${safe(data.summary, "No summary returned.")}</p>
              <p class="source-note"><strong>Data source:</strong> ${safe(data.data_source, "unknown").toUpperCase()} · ${safe(data.data_source_note, "")}</p>
              <span class="chip">Open-Meteo benchmarks</span>
              <span class="chip">Interpretive tasting layer</span>
              ${data.data_source === "vinou" ? '<span class="chip">Vinou source</span>' : '<span class="chip">OpenAI fallback</span>'}
            </div>
            <aside class="score">
              <div class="label">Vintage climate rank</div>
              <div class="value">${vintageRank(comparison)}</div>
              <div>${weatherInterpretation(comparison)}</div>
            </aside>
          </div>

          <div class="section-grid">
            <section class="panel">
              <h3>Wine Snapshot</h3>
              <div class="facts-grid">
                <div class="fact"><div class="label">Producer</div><div class="value">${safe(producerRegion.producer)}</div></div>
                <div class="fact"><div class="label">Region</div><div class="value">${safe(producerRegion.region)}</div></div>
                <div class="fact"><div class="label">Grapes</div><div class="value">${grapeNames}</div></div>
                <div class="fact"><div class="label">Blend</div><div class="value">${blend}</div></div>
                <div class="fact"><div class="label">Wine type</div><div class="value">${safe(data.raw_openai_payload?.wine_type, "Not classified")}</div></div>
                <div class="fact"><div class="label">ABV</div><div class="value">${safe(data.raw_openai_payload?.abv)}</div></div>
              </div>
            </section>

            <section class="panel">
              <h3>Vintage Weather Visualized</h3>
              <ul class="viz-list">
                ${vizRow("Avg high", comparison.selected_avg_high_c, comparison.average_avg_high_c, "°C")}
                ${vizRow("Peak high", comparison.selected_peak_high_c, comparison.average_peak_high_c, "°C")}
                ${vizRow("Avg low", comparison.selected_avg_low_c, comparison.average_avg_low_c, "°C")}
                ${vizRow("Rain total", comparison.selected_rain_total_mm, comparison.average_rain_total_mm, "mm")}
                ${vizRow("Rainy days", comparison.selected_rain_days, comparison.average_rain_days, "")}
              </ul>
            </section>

            <section class="panel">
              <h3>Tasting Profile</h3>
              <strong>Nose</strong>
              <ul>${listItems(tasting.aroma, "No aroma descriptors returned")}</ul>
              <strong>Palate</strong>
              <ul>${listItems(tasting.palate, "No palate descriptors returned")}</ul>
              <ul>
                <li><strong>Body:</strong> ${safe(mouth.body)}</li>
                <li><strong>Acidity:</strong> ${safe(mouth.acidity)}</li>
                <li><strong>Tannin:</strong> ${safe(mouth.tannin)}</li>
                <li><strong>Finish:</strong> ${safe(tasting.finish)}</li>
              </ul>
            </section>

            <section class="panel">
              <h3>Cellar & Market</h3>
              <ul>
                <li><strong>Drinking window:</strong> ${safe(mouth.cellaring_window)}</li>
                <li><strong>Estimated price:</strong> ${formatCurrency(price.avg)} (${formatCurrency(price.low)}–${formatCurrency(price.high)})</li>
                <li><strong>Availability:</strong> ${safe(data.raw_openai_payload?.availability_status, "Unknown")}</li>
                <li><strong>Comparables:</strong> ${safe(data.raw_openai_payload?.comparable_wines, "Not returned")}</li>
                <li><strong>Season window:</strong> ${safe(growing.start_month, "?")}/${safe(growing.start_day, "?")} → ${safe(growing.end_month, "?")}/${safe(growing.end_day, "?")}</li>
              </ul>
            </section>
          </div>

          <section class="panel metadata">
            <h3>System Metadata</h3>
            <ul>
              <li>Wine ID: ${safe(data.raw_openai_payload?.wine_id, "Pending")}</li>
              <li>Producer ID: ${safe(data.raw_openai_payload?.producer_id, "Pending")}</li>
            </ul>
          </section>
        `;
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const wineName = document.getElementById("name").value.trim();
        const vintageRaw = document.getElementById("vintage").value.trim();
        if (!wineName) {
          statusEl.textContent = "Please enter a wine name.";
          statusEl.className = "status error";
          return;
        }
        const params = new URLSearchParams({ name: wineName });
        if (vintageRaw) params.set("vintage", vintageRaw);

        statusEl.textContent = "Loading...";
        statusEl.className = "status";
        submitBtn.disabled = true;
        resultEl.textContent = "";

        try {
          const response = await fetch(`/explain-wine?${params.toString()}`);
          const data = await response.json();
          if (!response.ok) throw new Error(data.detail || "Request failed");
          resultEl.innerHTML = renderResult(data);
          statusEl.textContent = "Done.";
        } catch (error) {
          statusEl.textContent = error.message;
          statusEl.className = "status error";
          resultEl.textContent = "Could not retrieve wine details.";
        } finally {
          submitBtn.disabled = false;
        }
      });

      renderSearchHistory();
    </script>
  </body>
</html>
