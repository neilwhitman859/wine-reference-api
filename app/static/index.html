<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wine Reference</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@500;700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --ink: #1f1714;
        --muted: #5d4f49;
        --accent: #8a2f3f;
        --accent-soft: #f2d8c8;
        --surface: #fffaf7;
        --line: #e6d9d2;
        --shadow: 0 24px 50px rgba(31, 23, 20, 0.12);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Source Sans 3", "Helvetica Neue", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 10% 12%, rgba(225, 195, 170, 0.35), transparent 55%),
          radial-gradient(circle at 90% 8%, rgba(138, 47, 63, 0.18), transparent 48%),
          linear-gradient(180deg, #f6f1ec 0%, #f0e8e1 55%, #f7f4f1 100%);
      }
      main.page {
        max-width: 1040px;
        margin: 0 auto;
        padding: 48px 20px 64px;
        display: grid;
        gap: 28px;
      }
      .hero,
      .panel,
      .result-card,
      .detail-card {
        animation: fadeUp 0.6s ease both;
      }
      .hero {
        background: rgba(255, 250, 247, 0.86);
        border: 1px solid var(--line);
        border-radius: 22px;
        padding: 32px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(8px);
      }
      .hero .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 10px;
      }
      .hero h1 {
        font-family: "Fraunces", "Times New Roman", serif;
        font-size: clamp(30px, 4vw, 44px);
        margin: 0 0 12px;
      }
      .hero p {
        margin: 0;
        max-width: 620px;
        line-height: 1.6;
        color: var(--muted);
        font-size: 16px;
      }
      .hero-meta {
        margin-top: 22px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }
      .meta-item {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 14px 16px;
      }
      .meta-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      .meta-value {
        font-size: 15px;
        font-weight: 600;
      }
      .panel {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 22px;
        box-shadow: 0 16px 32px rgba(31, 23, 20, 0.08);
      }
      .form-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 170px) auto;
        gap: 16px;
        align-items: end;
      }
      .field label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .field input {
        width: 100%;
        border: 1px solid #d7cac3;
        border-radius: 10px;
        padding: 12px 14px;
        font-size: 15px;
        background: #fff;
      }
      .field input:focus {
        outline: 2px solid rgba(138, 47, 63, 0.2);
        border-color: var(--accent);
      }
      .hint {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .action button {
        border: 0;
        border-radius: 12px;
        padding: 12px 18px;
        background: var(--accent);
        color: #fff;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        min-height: 46px;
      }
      .action button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(138, 47, 63, 0.22);
      }
      .action button:disabled {
        opacity: 0.6;
        cursor: wait;
        box-shadow: none;
      }
      .status-row {
        margin-top: 16px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 13px;
        color: var(--muted);
      }
      .status.error {
        color: #a11a1a;
        font-weight: 600;
      }
      .results {
        display: grid;
        gap: 18px;
      }
      .result-card {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 22px;
        box-shadow: 0 18px 35px rgba(31, 23, 20, 0.08);
      }
      .result-head {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 12px;
      }
      .result-head .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .result-head h2 {
        margin: 0;
        font-family: "Fraunces", "Times New Roman", serif;
        font-size: 24px;
      }
      .pill {
        align-self: flex-start;
        padding: 6px 12px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: #61323a;
        font-weight: 600;
        font-size: 12px;
      }
      .result-text {
        white-space: pre-wrap;
        line-height: 1.6;
        color: #2a201d;
        font-size: 15px;
      }
      .detail-card {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.7);
        padding: 4px 18px 18px;
      }
      .detail-card summary {
        cursor: pointer;
        padding: 14px 0;
        font-weight: 600;
        list-style: none;
      }
      .detail-card summary::-webkit-details-marker {
        display: none;
      }
      .detail-card summary::before {
        content: "+";
        display: inline-block;
        margin-right: 8px;
        font-weight: 700;
        color: var(--accent);
      }
      .detail-card[open] summary::before {
        content: "-";
      }
      .detail-text {
        white-space: pre-wrap;
        line-height: 1.6;
        color: #2a201d;
        font-size: 14px;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @media (max-width: 860px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
        .hero-meta {
          grid-template-columns: 1fr;
        }
        .status-row {
          flex-direction: column;
          align-items: flex-start;
        }
        .result-head {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header class="hero">
        <div class="eyebrow">Wine Reference</div>
        <h1>Data-driven wine briefs with just enough depth.</h1>
        <p>
          Enter a wine name and optional vintage to generate a structured overview.
          The expanded section keeps extra detail out of the way until you want it.
        </p>
        <div class="hero-meta">
          <div class="meta-item">
            <span class="meta-label">Focus</span>
            <span class="meta-value">Producer, region, style</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Output</span>
            <span class="meta-value">Overview plus expandable detail</span>
          </div>
        </div>
      </header>

      <section class="panel">
        <form id="wine-form" class="form-grid">
          <div class="field">
            <label for="name">Wine name</label>
            <input id="name" name="name" placeholder="e.g., Ridge Geyserville" required />
            <div class="hint">Try a producer and cuvee, or a winery and region.</div>
          </div>
          <div class="field">
            <label for="vintage">Vintage (optional)</label>
            <input id="vintage" name="vintage" type="number" placeholder="e.g., 2022" min="1900" max="2100" />
            <div class="hint">Leave blank for non-vintage wines.</div>
          </div>
          <div class="field action">
            <button type="submit" id="submit-btn">Generate overview</button>
          </div>
        </form>

        <div class="status-row">
          <div id="status" class="status"></div>
          <div class="updated">Updated <time id="last-updated"></time></div>
        </div>
      </section>

      <section class="results">
        <article class="result-card">
          <div class="result-head">
            <div>
              <div class="eyebrow">Overview</div>
              <h2 id="result-title">Awaiting a request</h2>
            </div>
            <div class="pill" id="result-meta">No query yet</div>
          </div>
          <div id="overview" class="result-text">Your wine overview will appear here.</div>
        </article>

        <details class="detail-card" id="details-block" hidden>
          <summary>Expand for more detail</summary>
          <div id="details" class="detail-text"></div>
        </details>
      </section>
    </main>

    <script>
      const form = document.getElementById("wine-form");
      const statusEl = document.getElementById("status");
      const overviewEl = document.getElementById("overview");
      const detailsEl = document.getElementById("details");
      const detailsBlock = document.getElementById("details-block");
      const submitBtn = document.getElementById("submit-btn");
      const lastUpdatedEl = document.getElementById("last-updated");
      const resultTitleEl = document.getElementById("result-title");
      const resultMetaEl = document.getElementById("result-meta");

      const formattedUpdatedAt = new Date(document.lastModified).toLocaleString();
      lastUpdatedEl.textContent = formattedUpdatedAt;
      lastUpdatedEl.dateTime = new Date(document.lastModified).toISOString();

      const splitExplanation = (text) => {
        if (!text) {
          return { overview: "", detail: "" };
        }

        const paragraphs = text
          .split(/\n\s*\n/)
          .map((chunk) => chunk.trim())
          .filter(Boolean);

        if (paragraphs.length > 1) {
          return {
            overview: paragraphs[0],
            detail: paragraphs.slice(1).join("\n\n"),
          };
        }

        const sentences = text.match(/[^.!?]+[.!?]+/g);
        if (sentences && sentences.length > 2) {
          return {
            overview: sentences.slice(0, 2).join(" ").trim(),
            detail: sentences.slice(2).join(" ").trim(),
          };
        }

        return { overview: text.trim(), detail: "" };
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const wineName = document.getElementById("name").value.trim();
        const vintageRaw = document.getElementById("vintage").value.trim();

        if (!wineName) {
          statusEl.textContent = "Please enter a wine name.";
          statusEl.className = "status error";
          return;
        }

        const params = new URLSearchParams({ name: wineName });
        if (vintageRaw) {
          params.set("vintage", vintageRaw);
        }

        statusEl.textContent = "Loading overview...";
        statusEl.className = "status";
        submitBtn.disabled = true;
        resultTitleEl.textContent = "Gathering notes";
        resultMetaEl.textContent = "Working";
        overviewEl.textContent = "Analyzing producer, region, and style.";
        detailsEl.textContent = "";
        detailsBlock.hidden = true;

        try {
          const response = await fetch(`/explain-wine?${params.toString()}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.detail || "Request failed");
          }

          const heading = data.vintage ? `${data.wine} (${data.vintage})` : `${data.wine}`;
          const split = splitExplanation(data.explanation || "");

          resultTitleEl.textContent = heading;
          resultMetaEl.textContent = data.vintage ? `Vintage ${data.vintage}` : "Non-vintage";
          overviewEl.textContent = split.overview || "No overview returned.";

          if (split.detail) {
            detailsEl.textContent = split.detail;
            detailsBlock.hidden = false;
            detailsBlock.open = false;
          } else {
            detailsEl.textContent = "";
            detailsBlock.hidden = true;
          }

          statusEl.textContent = "Overview ready.";
        } catch (error) {
          statusEl.textContent = error.message;
          statusEl.className = "status error";
          resultTitleEl.textContent = "Request failed";
          resultMetaEl.textContent = "Try again";
          overviewEl.textContent = "Could not retrieve wine details.";
          detailsEl.textContent = "";
          detailsBlock.hidden = true;
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
