<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wine Reference API</title>
    <style>
      :root {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color-scheme: light;
      }
      body {
        margin: 0;
        background: #f7f4f2;
        color: #2e2523;
      }
      .wrap {
        max-width: 1100px;
        margin: 28px auto 40px;
        padding: 0 16px;
      }
      .card {
        background: #fff;
        border: 1px solid #e7ddda;
        border-radius: 16px;
        padding: 22px;
        box-shadow: 0 14px 30px rgba(55, 24, 21, 0.08);
      }
      h1 { margin: 0 0 8px; }
      .lead { color: #6a5a57; margin: 0 0 18px; }
      .grid {
        display: grid;
        grid-template-columns: 1fr 180px auto;
        gap: 10px;
        align-items: end;
      }
      label { display:block; margin-bottom: 6px; font-weight: 600; }
      input {
        width: 100%; box-sizing: border-box; border: 1px solid #dacfc9; border-radius: 8px;
        padding: 10px 12px; font-size: 14px;
      }
      button {
        border: 0; border-radius: 8px; background: #7b2237; color: white; padding: 11px 15px; font-weight: 700;
      }
      button:disabled { opacity: .6; }
      .status { margin-top: 10px; min-height: 18px; }
      .error { color: #a01818; }
      .history {
        margin-top: 14px; border: 1px solid #eadfda; border-radius: 10px; padding: 12px; background: #fffcfb;
      }
      .history h3 { margin:0 0 8px; font-size: 15px; }
      .history ul { margin:0; padding-left: 20px; }
      .result {
        margin-top: 16px;
        border: 1px solid #eadfda;
        border-radius: 12px;
        background: linear-gradient(180deg, #fff 0%, #fdfaf9 100%);
        padding: 18px;
        min-height: 120px;
      }
      .topline {
        display: flex; justify-content: space-between; gap: 14px; align-items: flex-start; margin-bottom: 10px;
      }
      .pill { font-size: 12px; border-radius: 999px; padding: 4px 10px; border: 1px solid #e4d9d4; background: #f7efec; display:inline-block; margin: 4px 8px 0 0; }
      .section {
        margin-top: 14px; border: 1px solid #e9dfdb; border-radius: 10px; padding: 14px; background: #fff;
      }
      .section h3 { margin: 0 0 8px; }
      .section h4 { margin: 10px 0 6px; font-size: 14px; color: #624d4b; }
      .facts-grid {
        display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px;
      }
      .fact {
        border: 1px solid #ecdfda; border-radius: 8px; background: #fffaf8; padding: 9px;
      }
      .fact .label { font-size: 12px; color: #6f5f5b; }
      .fact .value { font-weight: 700; margin-top: 2px; font-size: 14px; }
      .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
      .kpi { border: 1px solid #ecdfda; border-radius: 8px; padding: 10px; background: #fffaf7; }
      .kpi .label { font-size: 12px; color: #6f5f5b; }
      .kpi .value { font-size: 15px; font-weight: 700; margin-top: 2px; }
      ul { margin: 6px 0 0; padding-left: 20px; }
      .meta { margin-top: 12px; color: #6f5f5b; font-size: 13px; }
      .metadata { display:none; }
      @media (max-width: 860px) {
        .grid, .facts-grid, .kpi-grid { grid-template-columns: 1fr; }
        .topline { flex-direction: column; }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card">
        <h1>Wine Reference</h1>
        <p class="lead">A structured wine page with factual data, vintage environment metrics, and optional tasting/interpretive layers.</p>

        <form id="wine-form" class="grid">
          <div>
            <label for="name">Wine name</label>
            <input id="name" name="name" placeholder="e.g., Opus One" required />
          </div>
          <div>
            <label for="vintage">Vintage (optional)</label>
            <input id="vintage" name="vintage" type="number" placeholder="e.g., 2018" min="1900" max="2100" />
          </div>
          <div><button type="submit" id="submit-btn">Build wine page</button></div>
        </form>

        <div id="status" class="status"></div>
        <section class="history">
          <h3>Last 10 bottles searched</h3>
          <ul id="search-history"></ul>
        </section>
        <div id="result" class="result">Your structured wine page will appear here.</div>
        <div class="meta">Last updated: <time id="last-updated"></time></div>
      </section>
    </main>

    <script>
      const form = document.getElementById("wine-form");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      const submitBtn = document.getElementById("submit-btn");
      const lastUpdatedEl = document.getElementById("last-updated");
      const searchHistoryEl = document.getElementById("search-history");
      const SEARCH_HISTORY_KEY = "wine-search-history-v2";

      lastUpdatedEl.textContent = new Date(document.lastModified).toLocaleString();
      lastUpdatedEl.dateTime = new Date(document.lastModified).toISOString();

      const safe = (v, fallback = "Not disclosed") => (v === null || v === undefined || v === "" ? fallback : v);
      const listItems = (items = [], empty = "Not available") =>
        Array.isArray(items) && items.length ? items.map((i) => `<li>${i}</li>`).join("") : `<li>${empty}</li>`;

      const parseGrapes = (text = "") => {
        const matches = [...(text || "").matchAll(/(\d{1,3})\s?%\s*([A-Za-z][A-Za-z\s\-]+)/g)];
        if (!matches.length) return [];
        return matches.map((m) => ({ percent: Number(m[1]), grape: m[2].trim().replace(/[.,;:]$/, "") }));
      };

      const parseProducerRegion = (text = "") => {
        const parts = (text || "").split(",").map((p) => p.trim()).filter(Boolean);
        return {
          producer: parts[0] || "Not disclosed",
          region: parts.slice(1).join(", ") || "Not disclosed",
        };
      };

      const weatherInterpretation = (comparison = {}) => {
        if (!comparison || Object.keys(comparison).length === 0) return "No environmental interpretation available.";
        const high = comparison.avg_high_delta_c || 0;
        const rain = comparison.rain_total_delta_mm || 0;
        const tempRead = high >= 0 ? "warmer" : "cooler";
        const rainRead = rain >= 0 ? "wetter" : "drier";
        const tendency = high >= 0 ? "riper fruit and higher alcohol tendency" : "higher acidity and lower alcohol tendency";
        return `Vintage tracked ${Math.abs(high).toFixed(1)}°C ${tempRead} and ${Math.abs(rain).toFixed(1)}mm ${rainRead} vs average; tendency: ${tendency}.`;
      };

      const vintageRank = (comparison = {}) => {
        const bits = [];
        const high = comparison.avg_high_delta_c || 0;
        const rain = comparison.rain_total_delta_mm || 0;
        bits.push(high >= 0 ? "warmer than avg" : "cooler than avg");
        bits.push(rain >= 0 ? "wetter than avg" : "drier than avg");
        return bits.join(" · ");
      };

      const formatCurrency = (value) =>
        new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(value);

      const estimatePrice = (vintage, weather = {}) => {
        const yr = new Date().getFullYear();
        const age = vintage ? Math.max(0, yr - vintage) : 4;
        const tempDelta = Math.abs(weather?.selected_vs_average_comparison?.avg_high_delta_c || 0);
        const score = Math.max(0.8, 1.2 - tempDelta * 0.08);
        const avg = Math.round(45 * (1 + Math.min(age / 18, 0.8)) * score);
        return { avg, low: Math.max(20, Math.round(avg * 0.8)), high: Math.round(avg * 1.25) };
      };

      const loadSearchHistory = () => {
        try {
          const raw = localStorage.getItem(SEARCH_HISTORY_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch { return []; }
      };

      const saveSearchHistory = (entries) => localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(entries));

      const renderSearchHistory = () => {
        const entries = loadSearchHistory();
        searchHistoryEl.innerHTML = entries.length
          ? entries.map((e) => `<li><strong>${e.name}</strong> · ${e.vintage} · ${e.grapes}</li>`).join("")
          : "<li>No bottles searched yet.</li>";
      };

      const recordSearch = (entry) => {
        const entries = loadSearchHistory().filter((e) => !(e.name === entry.name && e.vintage === entry.vintage));
        entries.unshift(entry);
        saveSearchHistory(entries.slice(0, 10));
        renderSearchHistory();
      };

      const renderResult = (data) => {
        const breakdown = data.description_breakdown || {};
        const tasting = breakdown.tasting_profile || {};
        const mouth = breakdown.drinking_experience || {};
        const weather = data.growing_season_weather || {};
        const comparison = weather.selected_vs_average_comparison || {};
        const producerRegion = parseProducerRegion(breakdown.producer_and_region || "");
        const grapes = parseGrapes(breakdown.grape_composition_and_style || "");
        const grapeNames = grapes.length ? grapes.map((g) => g.grape).join(", ") : "Not disclosed";
        const blend = grapes.length ? grapes.map((g) => `${g.grape} ${g.percent}%`).join(", ") : "Optional / Not disclosed";
        const climate = data.raw_openai_payload?.climate_context || {};
        const growing = climate.growing_season || {};

        const price = estimatePrice(data.vintage, weather);
        recordSearch({ name: safe(data.wine, "Unknown wine"), vintage: safe(data.vintage, "N/V"), grapes: grapeNames });

        return `
          <div class="topline">
            <div>
              <h2>${safe(data.wine, "Wine")} ${data.vintage ? `(${data.vintage})` : ""}</h2>
              <p>${safe(data.summary, "No summary returned.")}</p>
              <span class="pill">Open-Meteo enabled</span>
              <span class="pill">AI interpretation layer</span>
            </div>
            <div>
              <strong>Climate rank:</strong> ${vintageRank(comparison)}
            </div>
          </div>

          <section class="section">
            <h3>1) Wine Facts (Knowable Without Tasting)</h3>
            <div class="facts-grid">
              <div class="fact"><div class="label">Wine Name</div><div class="value">${safe(data.wine)}</div></div>
              <div class="fact"><div class="label">Producer</div><div class="value">${safe(producerRegion.producer)}</div></div>
              <div class="fact"><div class="label">Vintage</div><div class="value">${safe(data.vintage, "N/V")}</div></div>
              <div class="fact"><div class="label">Wine Type</div><div class="value">${safe(data.raw_openai_payload?.wine_type, "Not classified")}</div></div>
              <div class="fact"><div class="label">Country / Region / Appellation</div><div class="value">${safe(producerRegion.region)}</div></div>
              <div class="fact"><div class="label">Grape Variety</div><div class="value">${grapeNames}</div></div>
              <div class="fact"><div class="label">Blend Percentages</div><div class="value">${blend}</div></div>
              <div class="fact"><div class="label">ABV</div><div class="value">${safe(data.raw_openai_payload?.abv)}</div></div>
              <div class="fact"><div class="label">Bottle Size(s)</div><div class="value">${safe(data.raw_openai_payload?.bottle_sizes)}</div></div>
              <div class="fact"><div class="label">Viticulture</div><div class="value">${safe(data.raw_openai_payload?.viticulture, "Organic/Biodynamic/Sustainable/Conventional not disclosed")}</div></div>
              <div class="fact"><div class="label">Single Vineyard</div><div class="value">${safe(data.raw_openai_payload?.single_vineyard, "Not disclosed")}</div></div>
              <div class="fact"><div class="label">Winemaking</div><div class="value">${safe(data.raw_openai_payload?.winemaking, "Fermentation/Aging/Filtration not disclosed")}</div></div>
            </div>
          </section>

          <section class="section">
            <h3>2) Vintage Environment (Open-Meteo Powered)</h3>
            <div class="kpi-grid">
              <div class="kpi"><div class="label">Growing Season Window</div><div class="value">${safe(growing.start_month, "?")}/${safe(growing.start_day, "?")} → ${safe(growing.end_month, "?")}/${safe(growing.end_day, "?")}</div></div>
              <div class="kpi"><div class="label">Average Temperature</div><div class="value">${comparison.avg_high_delta_c !== undefined ? `${Math.abs(comparison.avg_high_delta_c).toFixed(1)}°C delta` : "N/A"}</div></div>
              <div class="kpi"><div class="label">Total Rainfall</div><div class="value">${comparison.rain_total_delta_mm !== undefined ? `${Math.abs(comparison.rain_total_delta_mm).toFixed(1)}mm delta` : "N/A"}</div></div>
              <div class="kpi"><div class="label">Frost / Heatwave Events</div><div class="value">${safe(data.raw_openai_payload?.climate_flags, "Not explicitly returned")}</div></div>
            </div>
            <h4>Comparisons</h4>
            <ul>
              <li><strong>Vintage vs 10-year average:</strong> proxied using API baseline comparison (${safe(weather.all_years_period?.start_year, "N/A")}–${safe(weather.all_years_period?.end_year, "N/A")}).</li>
              <li><strong>Vintage rank:</strong> ${vintageRank(comparison)}</li>
              <li><strong>Simple interpretation:</strong> ${weatherInterpretation(comparison)}</li>
            </ul>
          </section>

          <section class="section">
            <h3>3) Tasting & Interpretation (Optional)</h3>
            <h4>Nose</h4><ul>${listItems(tasting.aroma, "No nose descriptors returned")}</ul>
            <h4>Palate</h4><ul>${listItems(tasting.palate, "No palate descriptors returned")}</ul>
            <h4>Structure</h4>
            <ul>
              <li><strong>Sweetness:</strong> ${safe(data.raw_openai_payload?.sweetness)}</li>
              <li><strong>Body:</strong> ${safe(mouth.body)}</li>
              <li><strong>Acidity:</strong> ${safe(mouth.acidity)}</li>
              <li><strong>Tannin:</strong> ${safe(mouth.tannin)}</li>
              <li><strong>Alcohol perception:</strong> ${safe(mouth.alcohol_impression)}</li>
              <li><strong>Finish:</strong> ${safe(tasting.finish)}</li>
              <li><strong>Freeform notes:</strong> ${safe(data.vintage_intelligence?.selected_vintage_assessment)}</li>
            </ul>
          </section>

          <section class="section">
            <h3>4) Style & Interpretation (Derived Layer)</h3>
            <p>${safe(data.summary)}</p>
            <ul>
              <li><strong>Comparable wines:</strong> ${safe(data.raw_openai_payload?.comparable_wines, "Not returned")}</li>
              <li><strong>Typical drinking window:</strong> ${safe(mouth.cellaring_window)}</li>
              <li><strong>Aging potential range:</strong> ${safe(data.raw_openai_payload?.aging_potential, "Not returned")}</li>
            </ul>
          </section>

          <section class="section">
            <h3>5) Market & Availability</h3>
            <ul>
              <li><strong>Avg market price:</strong> ${formatCurrency(price.avg)}</li>
              <li><strong>Price range:</strong> ${formatCurrency(price.low)} - ${formatCurrency(price.high)}</li>
              <li><strong>Affiliate links:</strong> ${safe(data.raw_openai_payload?.affiliate_links, "Not connected")}</li>
              <li><strong>Availability status:</strong> ${safe(data.raw_openai_payload?.availability_status, "Unknown")}</li>
            </ul>
          </section>

          <section class="section">
            <h3>6) Community Layer</h3>
            <ul>
              <li><strong>User ratings:</strong> ${safe(data.raw_openai_payload?.community?.ratings, "Not integrated")}</li>
              <li><strong>Favorites / Cellar:</strong> ${safe(data.raw_openai_payload?.community?.cellar_count, "Not integrated")}</li>
              <li><strong>User notes:</strong> ${safe(data.raw_openai_payload?.community?.notes, "Not integrated")}</li>
            </ul>
          </section>

          <section class="section metadata">
            <h3>7) System Metadata (Hidden)</h3>
            <ul>
              <li>Wine ID: ${safe(data.raw_openai_payload?.wine_id, "Pending")}</li>
              <li>Producer ID: ${safe(data.raw_openai_payload?.producer_id, "Pending")}</li>
              <li>Climate dataset version: Open-Meteo + local transform v1</li>
              <li>Last updated: ${new Date().toISOString()}</li>
            </ul>
          </section>
        `;
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const wineName = document.getElementById("name").value.trim();
        const vintageRaw = document.getElementById("vintage").value.trim();
        if (!wineName) {
          statusEl.textContent = "Please enter a wine name.";
          statusEl.className = "status error";
          return;
        }
        const params = new URLSearchParams({ name: wineName });
        if (vintageRaw) params.set("vintage", vintageRaw);

        statusEl.textContent = "Loading...";
        statusEl.className = "status";
        submitBtn.disabled = true;
        resultEl.textContent = "";

        try {
          const response = await fetch(`/explain-wine?${params.toString()}`);
          const data = await response.json();
          if (!response.ok) throw new Error(data.detail || "Request failed");
          resultEl.innerHTML = renderResult(data);
          statusEl.textContent = "Done.";
        } catch (error) {
          statusEl.textContent = error.message;
          statusEl.className = "status error";
          resultEl.textContent = "Could not retrieve wine details.";
        } finally {
          submitBtn.disabled = false;
        }
      });

      renderSearchHistory();
    </script>
  </body>
</html>
